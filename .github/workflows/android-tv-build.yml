name: Android TV Build (GeckoView)

on:
  push:
    tags:
      - 'v*.*.*'  # ä¸æ ‡å‡†ç‰ˆä¸€èµ·è§¦å‘
  workflow_dispatch:
    inputs:
      server_url:
        description: 'Server URL (e.g. https://your-site.com)'
        required: true
        default: 'https://ednovas.video'
      app_name:
        description: 'App Name'
        required: true
        default: 'Eè§†ç•ŒTV'
      version_tag:
        description: 'Version Tag (e.g. v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build-tv:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'android-tv/package-lock.json'

      - name: Setup Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Node dependencies
        working-directory: android-tv
        run: |
          npm install --legacy-peer-deps
          # postinstall è„šæœ¬ä¼šè‡ªåŠ¨å°† GeckoView åº”ç”¨åˆ° @capacitor/android
          echo "âœ… Dependencies installed"
        
      - name: Sync Capacitor Android
        working-directory: android-tv
        run: npx cap sync android

      # AGP 7 ä¸éœ€è¦ namespace patchingï¼Œè·³è¿‡æ­¤æ­¥éª¤

      - name: Apply GeckoView patches
        working-directory: android-tv
        run: |
          chmod +x patch-geckoview.sh
          ./patch-geckoview.sh

      # ä»…åœ¨æ‰‹åŠ¨è§¦å‘æ—¶ä¿®æ”¹é…ç½®
      - name: Configure App (Manual Build)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        working-directory: android-tv
        run: |
          echo "ğŸ“ Applying manual configuration..."
          tmp=$(mktemp)
          jq --arg url "${{ inputs.server_url }}" --arg name "${{ inputs.app_name }}" \
             '.server.url = $url | .appName = $name' capacitor.config.json > "$tmp" && mv "$tmp" capacitor.config.json
          
          echo "âœ… Configuration updated:"
          echo "   App Name: ${{ inputs.app_name }}"
          echo "   Server URL: ${{ inputs.server_url }}"

      - name: Show Capacitor Config
        working-directory: android-tv
        run: |
          echo "=== Capacitor Config ==="
          cat capacitor.config.json

      # ä»ç½‘ç«™å›¾æ ‡ç”Ÿæˆ Android App å›¾æ ‡
      - name: Generate App Icons from Website Icon
        run: |
          sudo apt-get update && sudo apt-get install -y imagemagick
          
          ICON_SRC="public/icon.png"
          DEST_DIR="android-tv/android/app/src/main/res"
          
          convert "$ICON_SRC" -resize 36x36 -background none -gravity center -extent 48x48 "$DEST_DIR/mipmap-mdpi/ic_launcher.png"
          convert "$ICON_SRC" -resize 36x36 -background none -gravity center -extent 48x48 "$DEST_DIR/mipmap-mdpi/ic_launcher_round.png"
          convert "$ICON_SRC" -resize 72x72 -background none -gravity center -extent 108x108 "$DEST_DIR/mipmap-mdpi/ic_launcher_foreground.png"
          
          convert "$ICON_SRC" -resize 54x54 -background none -gravity center -extent 72x72 "$DEST_DIR/mipmap-hdpi/ic_launcher.png"
          convert "$ICON_SRC" -resize 54x54 -background none -gravity center -extent 72x72 "$DEST_DIR/mipmap-hdpi/ic_launcher_round.png"
          convert "$ICON_SRC" -resize 108x108 -background none -gravity center -extent 162x162 "$DEST_DIR/mipmap-hdpi/ic_launcher_foreground.png"
          
          convert "$ICON_SRC" -resize 72x72 -background none -gravity center -extent 96x96 "$DEST_DIR/mipmap-xhdpi/ic_launcher.png"
          convert "$ICON_SRC" -resize 72x72 -background none -gravity center -extent 96x96 "$DEST_DIR/mipmap-xhdpi/ic_launcher_round.png"
          convert "$ICON_SRC" -resize 144x144 -background none -gravity center -extent 216x216 "$DEST_DIR/mipmap-xhdpi/ic_launcher_foreground.png"
          
          convert "$ICON_SRC" -resize 108x108 -background none -gravity center -extent 144x144 "$DEST_DIR/mipmap-xxhdpi/ic_launcher.png"
          convert "$ICON_SRC" -resize 108x108 -background none -gravity center -extent 144x144 "$DEST_DIR/mipmap-xxhdpi/ic_launcher_round.png"
          convert "$ICON_SRC" -resize 216x216 -background none -gravity center -extent 324x324 "$DEST_DIR/mipmap-xxhdpi/ic_launcher_foreground.png"
          
          convert "$ICON_SRC" -resize 144x144 -background none -gravity center -extent 192x192 "$DEST_DIR/mipmap-xxxhdpi/ic_launcher.png"
          convert "$ICON_SRC" -resize 144x144 -background none -gravity center -extent 192x192 "$DEST_DIR/mipmap-xxxhdpi/ic_launcher_round.png"
          convert "$ICON_SRC" -resize 288x288 -background none -gravity center -extent 432x432 "$DEST_DIR/mipmap-xxxhdpi/ic_launcher_foreground.png"
          
          echo "âœ… App icons generated from website icon"

      - name: Make gradlew executable
        run: chmod +x android-tv/android/gradlew

      # æ„å»º 5 ä¸ªç‰ˆæœ¬çš„ APK: 4ä¸ªå•æ¶æ„ + 1ä¸ªUniversal
      - name: Build All APKs (Per-Architecture + Universal)
        working-directory: android-tv/android
        run: |
          echo "ğŸ”¨ Building Universal APK (all architectures)..."
          ./gradlew assembleRelease
          
          echo "ğŸ”¨ Building per-architecture APKs..."
          # æ„å»ºå•ç‹¬æ¶æ„çš„ APK éœ€è¦å…ˆé…ç½® splits
          # ç”±äºæˆ‘ä»¬æ— æ³•ä¿®æ”¹ build.gradleï¼Œä½¿ç”¨ bundletool æå–å„æ¶æ„
          # è¿™é‡Œç›´æ¥æ„å»º universalï¼Œå•æ¶æ„ç‰ˆæœ¬é€šè¿‡æå–å®ç°

      - name: Get version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version_tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Signing Key
        id: keystore
        run: |
          KEYSTORE_FILE="release.keystore"
          if [ -n "${{ secrets.SIGNING_KEY }}" ]; then
            echo "ğŸ” Using Release Key from Secrets"
            echo "${{ secrets.SIGNING_KEY }}" | base64 -d > $KEYSTORE_FILE
            echo "STORE_PASS=${{ secrets.KEY_STORE_PASSWORD }}" >> $GITHUB_OUTPUT
            echo "KEY_ALIAS=${{ secrets.ALIAS }}" >> $GITHUB_OUTPUT
            echo "KEY_PASS=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No Secrets found. Generating Debug Key..."
            keytool -genkeypair -v \
              -keystore $KEYSTORE_FILE \
              -storetype PKCS12 \
              -storepass android \
              -alias androiddebugkey \
              -keypass android \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -dname "CN=Android Debug,O=Android,C=US"
            
            echo "STORE_PASS=android" >> $GITHUB_OUTPUT
            echo "KEY_ALIAS=androiddebugkey" >> $GITHUB_OUTPUT
            echo "KEY_PASS=android" >> $GITHUB_OUTPUT
          fi

      # è§£å‹ APK å¹¶é‡æ–°æ‰“åŒ…å„æ¶æ„ç‰ˆæœ¬
      - name: Create Per-Architecture APKs
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          BUILD_TOOLS_VERSION=$(ls $ANDROID_HOME/build-tools/ | sort -V | tail -n 1)
          APKSIGNER="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner"
          ZIPALIGN="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/zipalign"
          AAPT2="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/aapt2"
          
          UNSIGNED_APK="android-tv/android/app/build/outputs/apk/release/app-release-unsigned.apk"
          OUTPUT_DIR="android-tv/android/app/build/outputs/apk/release"
          WORK_DIR="apk_work"
          
          # åˆ›å»ºå·¥ä½œç›®å½•
          mkdir -p $WORK_DIR
          
          # è§£å‹ APK
          unzip -q "$UNSIGNED_APK" -d "$WORK_DIR/universal"
          
          # å„æ¶æ„
          ARCHS=("arm64-v8a" "armeabi-v7a" "x86" "x86_64")
          
          for ARCH in "${ARCHS[@]}"; do
            echo "ğŸ“¦ Creating APK for $ARCH..."
            ARCH_DIR="$WORK_DIR/$ARCH"
            mkdir -p "$ARCH_DIR"
            
            # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶
            cp -r "$WORK_DIR/universal/"* "$ARCH_DIR/"
            
            # åˆ é™¤å…¶ä»–æ¶æ„çš„ native libraries
            if [ -d "$ARCH_DIR/lib" ]; then
              for dir in "$ARCH_DIR/lib/"*; do
                if [ -d "$dir" ] && [ "$(basename $dir)" != "$ARCH" ]; then
                  rm -rf "$dir"
                fi
              done
            fi
            
            # é‡æ–°æ‰“åŒ…
            ARCH_APK_UNSIGNED="$OUTPUT_DIR/app-$ARCH-unsigned.apk"
            ARCH_APK_ALIGNED="$OUTPUT_DIR/app-$ARCH-aligned.apk"
            ARCH_APK_SIGNED="$OUTPUT_DIR/Eè§†ç•ŒTV-$VERSION-geckoview-$ARCH.apk"
            
            cd "$ARCH_DIR"
            zip -r -q "../../$ARCH_APK_UNSIGNED" .
            cd - > /dev/null
            
            # å¯¹é½
            $ZIPALIGN -v -p 4 "$ARCH_APK_UNSIGNED" "$ARCH_APK_ALIGNED"
            
            # ç­¾å
            $APKSIGNER sign \
              --ks "release.keystore" \
              --ks-pass pass:"${{ steps.keystore.outputs.STORE_PASS }}" \
              --ks-key-alias "${{ steps.keystore.outputs.KEY_ALIAS }}" \
              --key-pass pass:"${{ steps.keystore.outputs.KEY_PASS }}" \
              --out "$ARCH_APK_SIGNED" \
              "$ARCH_APK_ALIGNED"
            
            rm -f "$ARCH_APK_UNSIGNED" "$ARCH_APK_ALIGNED"
            
            echo "âœ… Created: $ARCH_APK_SIGNED"
          done
          
          # ç­¾å Universal APK
          echo "ğŸ“¦ Signing Universal APK..."
          UNIVERSAL_ALIGNED="$OUTPUT_DIR/app-universal-aligned.apk"
          UNIVERSAL_SIGNED="$OUTPUT_DIR/Eè§†ç•ŒTV-$VERSION-geckoview-universal.apk"
          
          $ZIPALIGN -v -p 4 "$UNSIGNED_APK" "$UNIVERSAL_ALIGNED"
          $APKSIGNER sign \
            --ks "release.keystore" \
            --ks-pass pass:"${{ steps.keystore.outputs.STORE_PASS }}" \
            --ks-key-alias "${{ steps.keystore.outputs.KEY_ALIAS }}" \
            --key-pass pass:"${{ steps.keystore.outputs.KEY_PASS }}" \
            --out "$UNIVERSAL_SIGNED" \
            "$UNIVERSAL_ALIGNED"
          
          rm -f "$UNSIGNED_APK" "$UNIVERSAL_ALIGNED"
          
          # æ¸…ç†
          rm -rf "$WORK_DIR" "release.keystore"
          
          echo "âœ… All APKs created successfully!"

      - name: List APK files
        run: |
          echo "=== APK Files ==="
          ls -lh android-tv/android/app/build/outputs/apk/release/*.apk

      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Eè§†ç•ŒTV-geckoview-apks
          path: android-tv/android/app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: Append to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: "Eè§†ç•Œ ${{ steps.version.outputs.VERSION }}"
          body: |
            ## ğŸ“º ç”µè§†ç›’å­ç‰ˆ (GeckoView) - ${{ steps.version.outputs.VERSION }}
            
            > âš ï¸ å¦‚æœæ ‡å‡†ç‰ˆ APK åœ¨ä½ çš„ç”µè§†ç›’å­ä¸Šå¡ä½æ— æ³•è¿è¡Œï¼Œè¯·ä½¿ç”¨æ­¤ç‰ˆæœ¬ï¼
            
            ### ğŸ“± GeckoView ç‰ˆæœ¬ä¸‹è½½
            
            | æ–‡ä»¶ | æ¶æ„ | ä½“ç§¯ | é€‚ç”¨è®¾å¤‡ |
            |------|------|------|----------|
            | `Eè§†ç•ŒTV-...-geckoview-arm64-v8a.apk` | ARM 64ä½ | ~100MB | å¤§å¤šæ•°ç°ä»£ç›’å­ |
            | `Eè§†ç•ŒTV-...-geckoview-armeabi-v7a.apk` | ARM 32ä½ | ~80MB | è€æ—§ç›’å­ |
            | `Eè§†ç•ŒTV-...-geckoview-x86_64.apk` | x86 64ä½ | ~100MB | æ¨¡æ‹Ÿå™¨/éƒ¨åˆ†å¹³æ¿ |
            | `Eè§†ç•ŒTV-...-geckoview-x86.apk` | x86 32ä½ | ~80MB | è€æ—§æ¨¡æ‹Ÿå™¨ |
            | `Eè§†ç•ŒTV-...-geckoview-universal.apk` | å…¨æ¶æ„ | ~350MB | é€šç”¨ç‰ˆ |
            
            > ğŸ’¡ **å¦‚ä½•é€‰æ‹©**ï¼šä¸ç¡®å®šè®¾å¤‡æ¶æ„æ—¶ï¼Œè¯·ä¸‹è½½ `universal` ç‰ˆæœ¬
            
            ### ğŸ”§ GeckoView ç‰ˆæœ¬ç‰¹ç‚¹
            - âœ… è‡ªå¸¦ Mozilla GeckoView æµè§ˆå™¨å¼•æ“
            - âœ… ä¸ä¾èµ–ç³»ç»Ÿ WebView ç‰ˆæœ¬
            - âœ… å…¼å®¹è€æ—§ç”µè§†ç›’å­å’ŒæŠ•å½±ä»ª
            
            ### ğŸ“º è®¾å¤‡å…¼å®¹æ€§
            - âœ… å°ç±³ç”µè§†/ç›’å­
            - âœ… æç±³æŠ•å½±ä»ª
            - âœ… å¤©çŒ«é­”ç›’
            - âœ… å…¶ä»–è€æ—§ Android ç›’å­
            
            ---
            
            > ğŸ’¡ æ™®é€šæ‰‹æœº/å¹³æ¿ç”¨æˆ·è¯·ä½¿ç”¨æ ‡å‡†ç‰ˆ APKï¼Œä½“ç§¯æ›´å°
          files: android-tv/android/app/build/outputs/apk/release/*.apk
          append_body: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
